<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel empresarial</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0f172a;              /* slate-900 */
      --panel:#111c33;           /* custom */
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --text:#e5e7eb;
      --muted:#94a3b8;           /* slate-400 */
      --border:rgba(148,163,184,.22);
      --border2:rgba(148,163,184,.14);

      --primary:#3b82f6;
      --danger:#ef4444;
      --warning:#f59e0b;
      --success:#22c55e;

      --radius:16px;
      --radius2:12px;
      --space:16px;

      --shadow: 0 12px 28px rgba(0,0,0,.30);
      --shadow2: 0 10px 22px rgba(0,0,0,.22);

      --h1: 20px;
      --h2: 13px;
      --text14: 13px;
      --kpiNum: 24px;

      --focus: 0 0 0 3px rgba(59,130,246,.35);
    }

    * { box-sizing: border-box; }

    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
      font-size: var(--text14);
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 12% -10%, rgba(59,130,246,.16), transparent 62%),
        radial-gradient(900px 520px at 92% 0%, rgba(34,197,94,.10), transparent 58%),
        radial-gradient(900px 520px at 50% 110%, rgba(245,158,11,.08), transparent 60%),
        var(--bg);
    }

    a { color: inherit; }

    .container{
      max-width: 1120px;
      margin: 22px auto 48px;
      padding: 0 20px;
    }

    /* HEADER */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
      margin-bottom: 14px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    h1{
      margin:0;
      font-size: var(--h1);
      font-weight: 900;
      letter-spacing:.2px;
      display:flex;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
    }

     <!-- DASHBOARD_VERSION: 2026-02-23 chart-wrap -->

    .role-pill{
      font-size: 11px;
      font-weight: 900;
      color: rgba(255,255,255,.90);
      background: rgba(59,130,246,.16);
      border: 1px solid rgba(59,130,246,.35);
      padding: 4px 10px;
      border-radius: 999px;
    }

    .sub{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      max-width: 720px;
    }

    .flash{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(17, 28, 51, .72);
      box-shadow: var(--shadow2);
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .flash.ok{ border-color: rgba(34,197,94,.35); }
    .flash.warn{ border-color: rgba(245,158,11,.35); }

    .top-actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* BUTTONS */
    .btn{
      background: var(--primary);
      color: white !important;
      padding: 9px 12px;
      border-radius: 12px;
      font-size: 12px;
      text-decoration: none;
      border: 1px solid rgba(255,255,255,.10);
      cursor: pointer;
      font-weight: 900;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow2);
      transition: transform .18s ease, filter .18s ease, border-color .18s ease;
      line-height: 1;
      height: 34px;
      white-space: nowrap;
    }
    .btn:hover{ filter: brightness(1.06); transform: translateY(-1px); }
    .btn:focus{ outline: none; box-shadow: var(--shadow2), var(--focus); }

    .btn-secondary{
      background: rgba(148,163,184,.14);
      border-color: rgba(148,163,184,.22);
      color: rgba(255,255,255,.92) !important;
    }
    .btn-secondary:hover{ border-color: rgba(59,130,246,.35); }
    .btn-danger{ background: rgba(239,68,68,.92); }

    .link{
      color: rgba(255,255,255,.88);
      text-decoration:none;
      font-size: 12px;
      font-weight: 900;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid transparent;
      transition: background .18s ease, border-color .18s ease;
      height: 34px;
      display:inline-flex;
      align-items:center;
    }
    .link:hover{
      background: rgba(255,255,255,.06);
      border-color: var(--border2);
    }
    .link:focus{ outline:none; box-shadow: var(--focus); }

    /* CARDS */
    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border-radius: var(--radius);
      padding: 18px;
      margin-bottom: var(--space);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      transition: transform .22s ease, border-color .22s ease;
    }
    .card:hover{
      transform: translateY(-1px);
      border-color: rgba(59,130,246,.28);
    }

    .card-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom: 10px;
      flex-wrap:wrap;
    }

    h2{
      margin:0;
      font-size: var(--h2);
      font-weight: 950;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: rgba(255,255,255,.88);
    }

    .small{
      font-size: 12px;
      color: var(--muted);
    }

    hr.sep{
      border:none;
      border-top:1px solid var(--border2);
      margin: 14px 0;
    }


    .chart-wrap{
      height: 260px;
      width: 100%;
      position: relative;
    }

    .chart-wrap canvas{
      width: 100% !important;
      height: 100% !important;
      display: block;
    }

    /* INPUT */
    input[type="file"],
    input[type="text"],
    input:not([type]){
      background: rgba(17, 28, 51, .65);
      border: 1px solid var(--border);
      color: white;
      padding: 10px 12px;
      border-radius: 12px;
      width: 100%;
      outline: none;
      height: 38px;
    }
    input:focus{ box-shadow: var(--focus); border-color: rgba(59,130,246,.45); }

    /* BADGES */
    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 950;
      border: 1px solid var(--border2);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      letter-spacing: .02em;
      white-space: nowrap;
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
    }
    .danger{ background: rgba(239,68,68,.14); color:#fecaca; border-color: rgba(239,68,68,.28); }
    .warn{ background: rgba(245,158,11,.14); color:#fde68a; border-color: rgba(245,158,11,.28); }
    .ok{ background: rgba(34,197,94,.14); color:#bbf7d0; border-color: rgba(34,197,94,.28); }

    /* KPIs */
    .kpis{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      margin-top: 12px;
    }
    @media(max-width:980px){
      .kpis{ grid-template-columns: repeat(2, 1fr); }
    }

    .kpi{
      background: rgba(17, 28, 51, .55);
      border: 1px solid var(--border2);
      border-radius: var(--radius2);
      padding: 12px;
      min-height: 78px;
    }
    .kpi-number{
      font-size: var(--kpiNum);
      font-weight: 950;
      letter-spacing: .2px;
    }
    .kpi-label{
      font-size: 11px;
      color: var(--muted);
      margin-top: 6px;
    }
    .kpi-danger{
      border: 1px solid rgba(239,68,68,.55);
      background: rgba(239,68,68,.08);
    }

    /* LAYOUT */
    .grid-2{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
    }
    @media(max-width:980px){
      .grid-2{ grid-template-columns: 1fr; }
    }

    /* TABLES */
    .table-scroll{
      max-height: 340px;
      overflow-y: auto;
      border-radius: 12px;
      border: 1px solid var(--border2);
      background: rgba(17, 28, 51, .35);
    }

    table{
      width: 100%;
      border-collapse: collapse;
      margin: 0;
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(148,163,184,.12);
      text-align: left;
      font-size: 12px;
      vertical-align: top;
    }
    th{
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.10em;
      color: var(--muted);
      position: sticky;
      top: 0;
      background: rgba(15, 23, 42, .92);
      backdrop-filter: blur(8px);
      z-index: 2;
    }

    tbody tr:nth-child(odd) td{ background: rgba(255,255,255,.02); }
    tbody tr:hover td{ background: rgba(59,130,246,.06); }

    .table-scroll::-webkit-scrollbar{ width: 8px; }
    .table-scroll::-webkit-scrollbar-thumb{
      background: rgba(59,130,246,.55);
      border-radius: 10px;
    }
    .table-scroll::-webkit-scrollbar-track{ background: transparent; }

    /* FILTERS */
    .filters{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .filter-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border2);
      background:rgba(17,28,51,.45);
      color: rgba(255,255,255,.90);
      font-size:12px;
      font-weight:900;
      text-decoration:none;
      transition: filter .18s ease, border-color .18s ease, background .18s ease;
    }
    .filter-chip:hover{ filter:brightness(1.06); border-color: rgba(59,130,246,.35); }
    .filter-chip.active{
      border-color: rgba(59,130,246,.55);
      background: rgba(59,130,246,.14);
    }

    /* EMPTY STATE */
    .empty{
      padding: 12px;
      border-radius: 12px;
      border: 1px dashed rgba(148,163,184,.22);
      background: rgba(17,28,51,.35);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }
  </style>
</head>

<body>
<div class="container">

  <!-- HEADER -->
  <div class="topbar">
    <div class="brand">
      <h1>
        {{ user }}
        <span class="role-pill">{{ rol|capitalize }}</span>
      </h1>
      <div class="sub">Gesti√≥n contractual empresarial ¬∑ Control, vencimientos y trazabilidad</div>

      {% if flash_msg %}
        <div class="flash ok">
          <div>‚úÖ</div>
          <div class="sub" style="margin:0;color:#bbf7d0;">{{ flash_msg }}</div>
        </div>
      {% endif %}

      {% if mensaje %}
        <div class="flash warn">
          <div>‚ÑπÔ∏è</div>
          <div class="sub" style="margin:0;color:#fde68a;">{{ mensaje }}</div>
        </div>
      {% endif %}
    </div>

    <div class="top-actions">
      <a class="btn btn-secondary" href="/exportar_excel">Exportar CSV</a>
      {% if rol == "admin" %}
        <a class="link" href="/admin/papelera">üóëÔ∏è Papelera</a>
      {% endif %}
      <a class="link" href="/config">Configuraci√≥n</a>
      <a class="link" href="/logout">Cerrar sesi√≥n</a>
    </div>
  </div>

  <!-- KPIs -->
  <div class="card">
    <div class="card-title">
      <h2>RESUMEN OPERATIVO</h2>
      <div class="small">Actualizado: {{ hoy }}</div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="kpi-number">{{ stats.total }}</div>
        <div class="kpi-label">Total contratos</div>
      </div>
      <div class="kpi">
        <div class="kpi-number">{{ stats.proximos }}</div>
        <div class="kpi-label">Vencen ‚â§ 30 d√≠as</div>
      </div>
      <div class="kpi">
        <div class="kpi-number">{{ stats.vencidos }}</div>
        <div class="kpi-label">Vencidos</div>
      </div>
      <div class="kpi">
        <div class="kpi-number">{{ stats.sin_fecha }}</div>
        <div class="kpi-label">Sin fecha</div>
      </div>
      <div class="kpi kpi-danger">
        <div class="kpi-number">{{ stats.fuera_sla if stats.fuera_sla is defined else 0 }}</div>
        <div class="kpi-label">Fuera de SLA interno</div>
      </div>
    </div>
  </div>

  <!-- Subir PDF -->
  <div class="card">
    <div class="card-title">
      <h2>Subir contrato</h2>
      <span class="small">Detecta fecha y tipo autom√°ticamente</span>
    </div>

    <form action="/subir_pdf/" method="post" enctype="multipart/form-data"
          style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <input type="file" name="file" accept="application/pdf" required style="max-width:360px;">
      <button class="btn" type="submit">Subir PDF</button>
      <span class="small">M√°x. 20MB ¬∑ Se guardar√° en tu empresa</span>
    </form>
  </div>

  <!-- Actividad reciente -->
  <div class="card" id="actividad">
    <div class="card-title">
      <h2>Actividad</h2>
      <div style="display:flex; gap:10px; align-items:center;">
        <span class="small">√öltimos movimientos</span>
        <a class="link" href="/actividad">Ver todo ‚Üí</a>
      </div>
    </div>

    {% if actividad and actividad|length > 0 %}
      <div class="table-scroll" style="max-height:260px;">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Usuario</th>
              <th>Acci√≥n</th>
              <th>Detalle</th>
            </tr>
          </thead>
          <tbody>
            {% for a in actividad %}
              <tr>
                <td>{{ (a.created_at|string)[:19].replace('T',' ') }}</td>
                <td><b>{{ a.actor_username }}</b></td>
                <td>
                  {% if a.action == "upload" %}
                    <span class="badge ok">Subi√≥</span>
                  {% elif a.action == "delete" %}
                    <span class="badge warn">Elimin√≥</span>
                  {% elif a.action == "restore" %}
                    <span class="badge ok">Restaur√≥</span>
                  {% elif a.action == "purge" %}
                    <span class="badge danger">Borrado definitivo</span>
                  {% elif a.action == "config_update" %}
                    <span class="badge warn">Configuraci√≥n</span>
                  {% else %}
                    <span class="badge">{{ a.action }}</span>
                  {% endif %}
                </td>
                <td>{{ a.entity_type }} {{ a.entity_id or "" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="empty">A√∫n no hay actividad registrada.</div>
    {% endif %}
  </div>

  <!-- 2 columnas: Riesgo + Gr√°fico -->
  <div class="grid-2">

    <!-- EXPOSICI√ìN CR√çTICA (‚â§ 7 D√çAS) -->
    <div class="card">
      <div class="card-title">
        <h2>EXPOSICI√ìN CR√çTICA (‚â§ 7 D√çAS)</h2>
        <span class="badge warn">‚â§ 7 d√≠as</span>
      </div>

      {% if vencen_7 and vencen_7|length > 0 %}
        <div class="table-scroll" style="max-height: 260px;">
          <table>
            <thead>
              <tr>
                <th>Documento</th><th>Tipo</th><th>Vence</th><th>D√≠as</th><th>Responsable</th>
              </tr>
            </thead>
            <tbody>
              {% for c in vencen_7 %}
                <tr>
                  <td><b>{{ c.archivo_pdf }}</b></td>
                  <td>{{ c.tipo }}</td>
                  <td>{{ c.fecha_fin }}</td>
                  <td>{{ c.dias }}</td>
                  <td>{{ c.owner }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="empty">Sin vencimientos cr√≠ticos.</div>
      {% endif %}

      <hr class="sep">

      <div class="card-title" style="margin-bottom:0;">
        <h2>VENCIMIENTOS PR√ìXIMOS (‚â§ 30 D√çAS)</h2>
        <span class="badge ok">‚â§ 30 d√≠as</span>
      </div>

      {% if vencen_30 and vencen_30|length > 0 %}
        <div class="table-scroll" style="max-height: 320px; margin-top: 10px;">
          <table>
            <thead>
              <tr>
                <th>Documento</th><th>Vence</th><th>D√≠as</th><th></th>
              </tr>
            </thead>
            <tbody>
              {% for c in vencen_30[:10] %}
                <tr>
                  <td>
                    <b>{{ c.archivo_pdf }}</b>
                    <div class="small">{{ c.tipo }} ¬∑ {{ c.owner }}</div>
                  </td>
                  <td>{{ c.fecha_fin }}</td>
                  <td>{{ c.dias }}</td>
                  <td><a class="btn btn-secondary" href="/descargar/?path={{ c.storage_path }}">Ver</a></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="small" style="margin-top:8px;">Mostrando 10 primeros. La tabla completa est√° abajo en ‚ÄúREPOSITORIO CONTRACTUAL‚Äù.</div>
      {% else %}
        <div class="empty">No hay contratos que venzan en los pr√≥ximos 30 d√≠as.</div>
      {% endif %}
    </div>

    <!-- Gr√°fico -->
    <div class="card">
      <div class="card-title">
        <h2>Vencimientos por mes</h2>
        <span class="small">Fin de contrato agrupado</span>
      </div>

      <div class="chart-wrap">
        <canvas id="vencimientosChart"></canvas>
      </div>

      {% if not grafico_labels or grafico_labels|length == 0 %}
        <div class="empty" style="margin-top:10px;">A√∫n no hay datos suficientes para el gr√°fico.</div>
      {% else %}
        <div class="small" style="margin-top:10px;">√ötil para detectar acumulaciones de renovaciones.</div>
      {% endif %}
    </div>
  </div>

  <!-- Buscador -->
  <div class="card">
    <div class="card-title">
      <h2>CONSULTA INTELIGENTE</h2>
      <span class="small">Consulta r√°pida</span>
    </div>
    <div class="sub">Ejemplos: ‚Äúvencen en 15 d√≠as‚Äù, ‚Äúlaborales‚Äù, ‚Äúsin fecha‚Äù.</div>
    <form action="/preguntar_contratos/" method="post" style="margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <input name="pregunta" placeholder="Ej: vencen en 15 d√≠as" style="flex: 1; min-width: 240px;">
      <button class="btn" type="submit">Preguntar</button>
    </form>
  </div>

  <!-- REPOSITORIO CONTRACTUAL -->
  <div class="card">
    <div class="card-title">
      <h2>REPOSITORIO CONTRACTUAL</h2>
      <span class="small">Tabla completa</span>
    </div>

    <div class="filters">
      <a class="filter-chip {% if not tipo_actual %}active{% endif %}" href="/">Todos</a>
      <a class="filter-chip {% if tipo_actual=='laboral' %}active{% endif %}" href="/?tipo=laboral">Laboral</a>
      <a class="filter-chip {% if tipo_actual=='alquiler' %}active{% endif %}" href="/?tipo=alquiler">Alquiler</a>
      <a class="filter-chip {% if tipo_actual=='servicios' %}active{% endif %}" href="/?tipo=servicios">Servicios</a>
      <a class="filter-chip {% if tipo_actual=='seguro' %}active{% endif %}" href="/?tipo=seguro">Seguro</a>
      <a class="filter-chip {% if tipo_actual=='otro' %}active{% endif %}" href="/?tipo=otro">Otro</a>
    </div>

    <div class="table-scroll" style="margin-top: 10px;">
      <table>
        <thead>
          <tr>
            <th>Documento</th>
            <th>Tipo</th>
            <th>Vence</th>
            <th>Responsable</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>

        <tbody>
          {% for c in todos %}
            <tr>
              <td><b>{{ c.archivo_pdf }}</b></td>
              <td>{{ c.tipo }}</td>
              <td>{{ c.fecha_fin or "‚Äî" }}</td>
              <td>{{ c.owner }}</td>
              <td>
                {% if not c.fecha_fin %}
                  <span class="badge warn">Sin fecha</span>
                {% else %}
                  {% if c.fecha_fin < hoy %}
                    <span class="badge danger">Vencido</span>
                  {% else %}
                    <span class="badge ok">Activo</span>
                  {% endif %}
                {% endif %}
              </td>
              <td style="display:flex; gap:8px; flex-wrap:wrap;">
                <a class="btn btn-secondary" href="/descargar/?path={{ c.storage_path }}">Descargar</a>
                {% if rol == "admin" %}
                  <form method="post" action="/admin/borrar_contrato" style="display:inline;">
                    <input type="hidden" name="contrato_id" value="{{ c.id }}">
                    <button class="btn btn-danger" type="submit"
                      onclick="return confirm('¬øEliminar? Se mover√° a papelera.')">Eliminar</button>
                  </form>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if todos|length == 0 %}
      <div class="empty" style="margin-top:10px;">No hay contratos para este filtro.</div>
    {% endif %}
  </div>

  <!-- Equipo -->
  {% if rol == "admin" %}
    <div class="card">
      <div class="card-title">
        <h2>Equipo</h2>
        <span class="small">Usuarios de tu empresa</span>
      </div>

      {% if miembros and miembros|length > 0 %}
        <div class="table-scroll" style="max-height: 320px;">
          <table>
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Rol</th>
                <th>Email alertas</th>
                <th>Creado</th>
              </tr>
            </thead>
            <tbody>
              {% for m in miembros %}
                <tr>
                  <td><b>{{ m.username }}</b></td>
                  <td>{{ m.rol }}</td>
                  <td>{{ m.email_alertas or "‚Äî" }}</td>
                  <td>{{ (m.creado_en|string)[:10] }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="empty">No hay miembros registrados.</div>
      {% endif %}
    </div>
  {% endif %}

</div>

<script>
(function(){
  const ctx = document.getElementById('vencimientosChart');
  if(!ctx) return;

  const labels = {{ grafico_labels|tojson }};
  const values = {{ grafico_values|tojson }};

  if(!labels || labels.length === 0) return;

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Contratos',
        data: values,
        backgroundColor: 'rgba(59,130,246,0.62)',
        borderColor: 'rgba(59,130,246,0.95)',
        borderWidth: 1,
        borderRadius: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          displayColors: false,
          callbacks: {
            label: (ctx) => ` ${ctx.parsed.y} contratos`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0 },
          grid: { color: 'rgba(255,255,255,.06)' }
        },
        x: {
          grid: { color: 'rgba(255,255,255,.04)' }
        }
      }
    }
  });
})();
</script>

</body>
</html>