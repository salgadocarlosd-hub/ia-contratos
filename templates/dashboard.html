<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Panel empresarial</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#1e2430;
  --card:#252c3b;
  --card-light:#2d3547;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --primary:#3b82f6;
  --danger:#ef4444;
  --warning:#f59e0b;
  --success:#22c55e;
  --border:#374151;

  /* ‚úÖ Vendible: m√°s compacto + m√°s pro */
  --space: 16px;
  --radius: 16px;

  --h1: 20px;
  --h2: 14px;
  --text14: 13px;
  --kpiNum: 24px;

  /* sombras y bordes m√°s ‚Äúpremium‚Äù */
  --shadow: 0 18px 45px rgba(0,0,0,.35);
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  font-size: var(--text14);
  background:radial-gradient(1200px 600px at 20% 0%, rgba(59,130,246,.10), transparent 60%),
             radial-gradient(1000px 600px at 90% 10%, rgba(34,197,94,.06), transparent 55%),
             var(--bg);
  color:var(--text);
}

.container{
  max-width:1100px;
  margin:24px auto;
  padding:0 20px;
}

.topbar{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:16px;
  margin-bottom:18px;
}

h1{
  margin:0;
  font-size:var(--h1);
  font-weight:800;
  letter-spacing:.2px;
}

.sub{
  color:var(--muted);
  font-size:12px;
  margin-top:6px;
  line-height:1.35;
}

.top-actions{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}

.top-actions a{
  color:var(--primary);
  text-decoration:none;
  font-size:12px;
  font-weight:800;
}

.card{
  background: linear-gradient(
    180deg,
    rgba(255,255,255,.05),
    rgba(255,255,255,.02)
  );
  border-radius: var(--radius);
  padding: 18px;
  margin-bottom: var(--space);
  border: 1px solid rgba(255,255,255,.06);
  box-shadow: var(--shadow);
  transition: all .25s ease;
}

/* efecto sutil al pasar el mouse (muy SaaS moderno) */
.card:hover{
  transform: translateY(-2px);
  border-color: rgba(59,130,246,.35);
}

.card-title{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:10px;
}

h2{
  margin:0;
  font-size:var(--h2);
  font-weight:900;
  letter-spacing:.2px;
}

.small{
  font-size:12px;
  color:var(--muted);
}

.btn{
  background:var(--primary);
  color:white !important;
  padding:8px 12px;
  border-radius:10px;
  font-size:12px;
  text-decoration:none;
  border:none;
  cursor:pointer;
  font-weight:900;
  display:inline-flex;
  align-items:center;
  gap:8px;
}
.btn:hover{filter:brightness(1.07)}
.btn-danger{background:var(--danger)}
.btn-secondary{background:#4b5563}

input{
  background:rgba(45,53,71,.85);
  border:1px solid rgba(55,65,81,.75);
  color:white;
  padding:10px 12px;
  border-radius:10px;
  width:100%;
  outline:none;
}

.badge{
  padding:5px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:900;
  border:1px solid rgba(255,255,255,.08);
  display:inline-flex;
  align-items:center;
  gap:6px;
}

.danger{background:rgba(239,68,68,0.16);color:#fecaca;}
.warn{background:rgba(245,158,11,0.16);color:#fde68a;}
.ok{background:rgba(34,197,94,0.16);color:#bbf7d0;}

hr.sep{
  border:none;
  border-top:1px solid rgba(55,65,81,.75);
  margin:14px 0;
}

/* KPIs: 5 columnas */
.kpis{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:12px;
  margin-top:12px;
}
@media(max-width:980px){
  .kpis{grid-template-columns:repeat(2,1fr)}
}

.kpi{
  background:rgba(45,53,71,.55);
  border:1px solid rgba(55,65,81,.75);
  border-radius:12px;
  padding:12px;
  min-height:72px;
}
.kpi-number{
  font-size:var(--kpiNum);
  font-weight:900;
}
.kpi-label{
  font-size:11px;
  color:var(--muted);
  margin-top:6px;
}
.kpi-danger{
  border-color: rgba(239,68,68,.5);
  background: rgba(239,68,68,.06);
}

/* Layout 2 columnas */
.grid-2{
  display:grid;
  grid-template-columns: 1.1fr .9fr;
  gap:14px;
}
@media(max-width:980px){
  .grid-2{grid-template-columns:1fr}
}

/* tablas */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td{
  padding:10px 10px;
  border-bottom:1px solid rgba(55,65,81,.65);
  text-align:left;
  font-size:12px;
}
th{
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:0.10em;
  color:var(--muted);
}

/* scroll profesional en tablas */
.table-scroll{
  max-height: 340px;
  overflow-y: auto;
  border-radius: 12px;
}

.table-scroll::-webkit-scrollbar{ width: 8px; }
.table-scroll::-webkit-scrollbar-thumb{
  background: rgba(59,130,246,.6);
  border-radius: 10px;
}
.table-scroll::-webkit-scrollbar-track{ background: transparent; }

/* header fijo en scroll */
.table-scroll thead th{
  position: sticky;
  top: 0;
  background: rgba(37,44,59,.98);
  backdrop-filter: blur(6px);
  z-index: 2;
}

/* filtros */
.filters{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
}
.filter-chip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(55,65,81,.85);
  background:rgba(45,53,71,.55);
  color:var(--text);
  font-size:12px;
  font-weight:900;
  text-decoration:none;
}
.filter-chip:hover{filter:brightness(1.06)}
.filter-chip.active{
  border-color: rgba(59,130,246,.55);
  background: rgba(59,130,246,.15);
}
</style>
</head>

<body>
<div class="container">

  <!-- HEADER -->
  <div class="topbar">
    <div>
      <h1>{{ user }} ‚Äî {{ rol|capitalize }}</h1>
      <div class="sub">Gesti√≥n contractual empresarial ¬∑ Control, vencimientos y trazabilidad</div>

      {% if flash_msg %}
        <div class="sub" style="margin-top:10px;color:#bbf7d0;">‚úÖ {{ flash_msg }}</div>
      {% endif %}
      {% if mensaje %}
        <div class="sub" style="margin-top:10px;color:#fde68a;">{{ mensaje }}</div>
      {% endif %}
    </div>

    <div class="top-actions">
      <a class="btn btn-secondary" href="/exportar_excel">Exportar CSV</a>
      {% if rol == "admin" %}
        <a href="/admin/papelera">üóëÔ∏è Papelera</a>
      {% endif %}
      <a href="/config">Configuraci√≥n</a>
      <a href="/logout">Cerrar sesi√≥n</a>
    </div>
  </div>

  <!-- KPIs -->
  <div class="card">
    <div class="card-title">
      <h2>Indicadores clave</h2>
      <div class="small">Actualizado: {{ hoy }}</div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="kpi-number">{{ stats.total }}</div>
        <div class="kpi-label">Total contratos</div>
      </div>
      <div class="kpi">
        <div class="kpi-number">{{ stats.proximos }}</div>
        <div class="kpi-label">Vencen ‚â§ 30 d√≠as</div>
      </div>
      <div class="kpi">
        <div class="kpi-number">{{ stats.vencidos }}</div>
        <div class="kpi-label">Vencidos</div>
      </div>
      <div class="kpi">
        <div class="kpi-number">{{ stats.sin_fecha }}</div>
        <div class="kpi-label">Sin fecha</div>
      </div>

      <!-- KPI extra (si lo env√≠as desde backend); si no existe, muestra 0 -->
      <div class="kpi kpi-danger">
        <div class="kpi-number">{{ stats.fuera_sla if stats.fuera_sla is defined else 0 }}</div>
        <div class="kpi-label">Fuera de SLA interno</div>
      </div>
    </div>
  </div>

  <!-- Subir PDF -->
  <div class="card">
    <div class="card-title">
      <h2>Subir contrato (PDF)</h2>
      <span class="small">Detectamos fecha de fin y tipo autom√°ticamente</span>
    </div>

    <form action="/subir_pdf/" method="post" enctype="multipart/form-data"
          style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <input type="file" name="file" accept="application/pdf" required style="max-width:340px;">
      <button class="btn" type="submit">Subir PDF</button>
      <span class="small">M√°x. 20MB ¬∑ Se guardar√° en tu empresa</span>
    </form>
  </div>

  <!-- Actividad reciente (CUADRO NORMAL + SCROLL) -->
  <div class="card" id="actividad">
    <div class="card-title">
                <h2>Actividad reciente</h2>
                <div>
                    <span class="small">√öltimos movimientos en la cuenta</span>
                    <a href="/actividad" class="small" style="margin-left:12px;color:var(--primary);font-weight:700;">
                         Ver todo ‚Üí
                    </a>
               </div>
          </div>

    {% if actividad and actividad|length > 0 %}
      <div class="table-scroll" style="max-height:260px;">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Usuario</th>
              <th>Acci√≥n</th>
              <th>Detalle</th>
            </tr>
          </thead>
          <tbody>
            {% for a in actividad %}
              <tr>
                <td>{{ (a.created_at|string)[:19].replace('T',' ') }}</td>
                <td><b>{{ a.actor_username }}</b></td>
                <td>
                  {% if a.action == "upload" %}
                    <span class="badge ok">Subi√≥</span>
                  {% elif a.action == "delete" %}
                    <span class="badge warn">Elimin√≥</span>
                  {% elif a.action == "restore" %}
                    <span class="badge ok">Restaur√≥</span>
                  {% elif a.action == "purge" %}
                    <span class="badge danger">Borrado definitivo</span>
                  {% elif a.action == "config_update" %}
                    <span class="badge warn">Configuraci√≥n</span>
                  {% else %}
                    <span class="badge">{{ a.action }}</span>
                  {% endif %}
                </td>
                <td>{{ a.entity_type }} {{ a.entity_id or "" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="sub">A√∫n no hay actividad registrada.</div>
    {% endif %}
  </div>

  <!-- 2 columnas: Riesgo + Gr√°fico -->
  <div class="grid-2">

    <!-- Riesgo inmediato -->
    <div class="card">
      <div class="card-title">
        <h2>Riesgo inmediato (‚â§ 7 d√≠as)</h2>
        <span class="badge warn">Prioridad</span>
      </div>

      {% if vencen_7 and vencen_7|length > 0 %}
        <table>
          <thead>
            <tr>
              <th>Documento</th><th>Tipo</th><th>Vence</th><th>D√≠as</th><th>Responsable</th>
            </tr>
          </thead>
          <tbody>
            {% for c in vencen_7 %}
              <tr>
                <td><b>{{ c.archivo_pdf }}</b></td>
                <td>{{ c.tipo }}</td>
                <td>{{ c.fecha_fin }}</td>
                <td>{{ c.dias }}</td>
                <td>{{ c.owner }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="sub">Sin vencimientos cr√≠ticos.</div>
      {% endif %}

      <hr class="sep">

      <div class="card-title" style="margin-bottom:0;">
        <h2>Vencen ‚â§ 30 d√≠as</h2>
        <span class="badge ok">Seguimiento</span>
      </div>

      {% if vencen_30 and vencen_30|length > 0 %}
        <table>
          <thead>
            <tr>
              <th>Documento</th><th>Vence</th><th>D√≠as</th><th></th>
            </tr>
          </thead>
          <tbody>
            {% for c in vencen_30[:8] %}
              <tr>
                <td><b>{{ c.archivo_pdf }}</b><div class="small">{{ c.tipo }} ¬∑ {{ c.owner }}</div></td>
                <td>{{ c.fecha_fin }}</td>
                <td>{{ c.dias }}</td>
                <td><a class="btn btn-secondary" href="/descargar/?path={{ c.storage_path }}">Ver</a></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="small" style="margin-top:8px;">Mostrando 8 primeros. La tabla completa est√° en ‚ÄúGesti√≥n documental‚Äù.</div>
      {% else %}
        <div class="sub">No hay contratos que venzan en los pr√≥ximos 30 d√≠as.</div>
      {% endif %}
    </div>

    <!-- Gr√°fico -->
    <div class="card">
      <div class="card-title">
        <h2>Vencimientos por mes</h2>
        <span class="small">Distribuci√≥n de fin de contrato</span>
      </div>

      <canvas id="vencimientosChart" height="170"></canvas>

      {% if not grafico_labels or grafico_labels|length == 0 %}
        <div class="sub" style="margin-top:10px;">A√∫n no hay datos suficientes para el gr√°fico.</div>
      {% else %}
        <div class="small" style="margin-top:10px;">√ötil para ver acumulaciones de renovaciones en ciertos meses.</div>
      {% endif %}
    </div>
  </div>

  <!-- Buscador -->
  <div class="card">
    <div class="card-title">
      <h2>Buscar contratos</h2>
      <span class="small">Consulta r√°pida</span>
    </div>
    <div class="sub">Ejemplos: ‚Äúvencen en 15 d√≠as‚Äù, ‚Äúlaborales‚Äù, ‚Äúsin fecha‚Äù.</div>
    <form action="/preguntar_contratos/" method="post" style="margin-top:12px; display:flex; gap:10px; align-items:center;">
      <input name="pregunta" placeholder="Ej: vencen en 15 d√≠as">
      <button class="btn" type="submit">Preguntar</button>
    </form>
  </div>

  <!-- Gesti√≥n documental -->
  <div class="card">
    <div class="card-title">
      <h2>Gesti√≥n documental</h2>
      <span class="small">Tabla completa</span>
    </div>

    <div class="filters">
      <a class="filter-chip active" href="#actividad">Todos</a>
      <a class="filter-chip {% if tipo_actual=='laboral' %}active{% endif %}" href="/?tipo=laboral">Laboral</a>
      <a class="filter-chip {% if tipo_actual=='alquiler' %}active{% endif %}" href="/?tipo=alquiler">Alquiler</a>
      <a class="filter-chip {% if tipo_actual=='servicios' %}active{% endif %}" href="/?tipo=servicios">Servicios</a>
      <a class="filter-chip {% if tipo_actual=='seguro' %}active{% endif %}" href="/?tipo=seguro">Seguro</a>
      <a class="filter-chip {% if tipo_actual=='otro' %}active{% endif %}" href="/?tipo=otro">Otro</a>
    </div>

    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>Documento</th>
            <th>Tipo</th>
            <th>Vence</th>
            <th>Responsable</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>

        <tbody>
          {% for c in todos %}
            <tr>
              <td><b>{{ c.archivo_pdf }}</b></td>
              <td>{{ c.tipo }}</td>
              <td>{{ c.fecha_fin or "‚Äî" }}</td>
              <td>{{ c.owner }}</td>

              <!-- FIX: no comparar None con string -->
              <td>
                {% if not c.fecha_fin %}
                  <span class="badge warn">Sin fecha</span>
                {% else %}
                  {% if c.fecha_fin < hoy %}
                    <span class="badge danger">Vencido</span>
                  {% else %}
                    <span class="badge ok">Activo</span>
                  {% endif %}
                {% endif %}
              </td>

              <td>
                <a class="btn" href="/descargar/?path={{ c.storage_path }}">Descargar</a>
                {% if rol == "admin" %}
                  <form method="post" action="/admin/borrar_contrato" style="display:inline;">
                    <input type="hidden" name="contrato_id" value="{{ c.id }}">
                    <button class="btn btn-danger" type="submit" onclick="return confirm('¬øEliminar? Se mover√° a papelera.')">Eliminar</button>
                  </form>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if todos|length == 0 %}
      <div class="sub" style="margin-top:10px;">No hay contratos para este filtro.</div>
    {% endif %}
  </div>

  <!-- Equipo -->
  {% if rol == "admin" %}
    <div class="card">
      <div class="card-title">
        <h2>Equipo</h2>
        <span class="small">Usuarios de tu empresa</span>
      </div>

      {% if miembros and miembros|length > 0 %}
        <table>
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Rol</th>
              <th>Email alertas</th>
              <th>Creado</th>
            </tr>
          </thead>
          <tbody>
            {% for m in miembros %}
              <tr>
                <td><b>{{ m.username }}</b></td>
                <td>{{ m.rol }}</td>
                <td>{{ m.email_alertas or "‚Äî" }}</td>
                <td>{{ (m.creado_en|string)[:10] }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="sub">No hay miembros registrados.</div>
      {% endif %}
    </div>
  {% endif %}

</div>

<script>
(function(){
  const ctx = document.getElementById('vencimientosChart');
  if(!ctx) return;

  const labels = {{ grafico_labels|tojson }};
  const values = {{ grafico_values|tojson }};

  if(!labels || labels.length === 0) return;

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Contratos',
        data: values,
        backgroundColor: 'rgba(59,130,246,0.65)',
        borderColor: 'rgba(59,130,246,1)',
        borderWidth: 1,
        borderRadius: 8
      }]
    },
    options: {
      plugins: { legend: { display:false } },
      scales: {
        y: { beginAtZero:true, ticks: { precision: 0 }, grid: { color: 'rgba(255,255,255,.06)' } },
        x: { grid: { color: 'rgba(255,255,255,.06)' } }
      }
    }
  });
})();
</script>

</body>
</html>
