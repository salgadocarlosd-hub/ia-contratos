<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel de contratos</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; color:#111; }
    a { color:#2563eb; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; background:#fff; }
    .grid { display:grid; grid-template-columns: 1fr; gap:16px; max-width: 980px; }
    .title { font-size:28px; font-weight:800; margin: 0 0 8px; }
    .subtitle { margin:0; color:#374151; }
    .btn { border:1px solid #d1d5db; background:#111827; color:white; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .btn:hover { filter:brightness(1.05); }
    .btn-secondary { background:#fff; color:#111827; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    input[type="file"] { border:1px solid #d1d5db; padding:8px; border-radius:10px; background:#fff; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:10px 12px; border-bottom:1px solid #e5e7eb; }
    th { font-size:12px; text-transform:uppercase; letter-spacing:.06em; color:#6b7280; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb; }
    .pill-danger { background:#fee2e2; border-color:#fecaca; color:#991b1b; }
    .pill-warn { background:#ffedd5; border-color:#fed7aa; color:#9a3412; }
    .pill-ok { background:#dcfce7; border-color:#bbf7d0; color:#166534; }
    .muted { color:#6b7280; }
    .msg { margin-top:10px; padding:10px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#f9fafb; }
  </style>
</head>
<body>

  <div class="topbar">
    <div>
      <div class="muted">Hola, <b>{{ user }}</b></div>
      <div class="muted">Rol: <b>{{ rol }}</b></div>
    </div>
    <div class="row">
      <a href="/config">Configuración</a>
      <span class="muted">—</span>
      <a href="/logout">Salir</a>
    </div>
  </div>

  <div class="grid">

    <div class="card">
      <h1 class="title">Contratos próximos a vencer</h1>
      <p class="subtitle">Aquí verás los contratos con fecha fin detectada dentro de 30 días.</p>

      {% if mensaje %}
        <div class="msg">{{ mensaje }}</div>
      {% endif %}
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px;">Subir nuevo contrato</h2>

      <form action="/subir_pdf/" method="post" enctype="multipart/form-data" class="row">
        <input type="file" name="file" accept="application/pdf" required />
        <button class="btn" type="submit">Subir PDF</button>
        <a class="btn btn-secondary" href="/enviar_alertas/?dias=30" style="display:inline-block; padding:10px 14px; border-radius:10px;">
          Enviar alertas (30 días)
        </a>
      </form>

      <p class="muted" style="margin:10px 0 0;">
        Consejo: si el PDF es escaneado, puede que no detecte texto (en Render suele estar OCR limitado).
      </p>
    </div>

    <div class="card">
      <h2>Preguntar a mis contratos</h2>

      <form action="/preguntar_contratos/" method="post">
        <input type="text"
               name="pregunta"
               placeholder="¿Qué contratos vencen pronto?"
               style="width:60%; padding:8px;">
        <button class="btn" type="submit">Preguntar</button>
      </form>
    </div>
    <!-- ✅ NUEVO BLOQUE: Últimos contratos -->
    <div class="card">
      <h2 style="margin:0 0 10px;">Últimos contratos subidos</h2>

      {% if ultimos and ultimos|length > 0 %}
        <ul style="margin:0; padding-left:18px;">
          {% for c in ultimos %}
            <li style="margin:6px 0;">
              <b>{{ c.get("archivo_pdf","") }}</b>
              — tipo: {{ c.get("tipo","otro") }}
              {% if c.get("fecha_fin") %} — fin: {{ c.get("fecha_fin") }}{% endif %}
              {% if c.get("owner") %} — subido por: {{ c.get("owner") }}{% endif %}
              {% if c.get("storage_path") %}
                — <a href="/descargar/?path={{ c.get('storage_path') }}">Descargar</a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted" style="margin:0;">Aún no hay contratos subidos en esta empresa.</p>
      {% endif %}
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px;">Listado</h2>

      {% if contratos and contratos|length > 0 %}
        <table>
          <thead>
            <tr>
              <th>Archivo</th>
              <th>Tipo</th>
              <th>Vence el</th>
              <th>Días restantes</th>
              <th>Estado</th>
              <th>PDF</th>
            </tr>
          </thead>
          <tbody>
            {% for c in contratos %}
              {% set dias = c.get("dias_restantes", 999999) %}
              <tr>
                <td><b>{{ c.get("archivo_pdf","") }}</b></td>
                <td>{{ c.get("tipo","otro") }}</td>
                <td>{{ c.get("vence_el","") }}</td>
                <td>{{ dias }}</td>
                <td>
                  {% if dias <= 7 %}
                    <span class="pill pill-danger">Urgente</span>
                  {% elif dias <= 30 %}
                    <span class="pill pill-warn">Próximo</span>
                  {% else %}
                    <span class="pill pill-ok">OK</span>
                  {% endif %}
                </td>
                <td>
                  {% if c.get("storage_path") %}
                    <a href="/descargar/?path={{ c.get('storage_path') }}">Descargar</a>
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                    </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="muted" style="margin:0;">
          Aún no hay contratos próximos a vencer. Sube un PDF arriba para empezar.
        </p>
      {% endif %}
    </div>

  </div>

</body>
</html>
